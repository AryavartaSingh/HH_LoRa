//libraries
#include <Keypad.h>
#include <U8g2lib.h>
#include <Wire.h>
#include <ezButton.h>
//definitions
#define ROWS 4
#define COLS 4
char keyMap[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'.','0','F','D'}
};
const byte disp_row[5] = {0, 15, 31, 47, 63};
ezButton but_abort(33);
ezButton but_rtb(4);
ezButton but_send(13);
char raw_packet[30];
int A_val = 0;
float L_base_val = 28.123456;
float O_base_val = 77.123456;
int S_val = 5;
int F_val = 8;
int new_A_val;
float new_L_base_val;
float new_O_base_val;
int new_S_val;
int new_F_val;

//pins
uint8_t rowPins[ROWS] = {32,27,26,25};
uint8_t colPins[COLS] = {19,18,17,16};
Keypad keypad = Keypad(makeKeymap(keyMap), rowPins, colPins, ROWS, COLS);
U8G2_SSD1309_128X64_NONAME0_F_HW_I2C u8g2(U8G2_R0); //constructor for displa

//bmp
#define logo_width 40
#define logo_height 40
const unsigned char PROGMEM logo_bits[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x81, 
  0x01, 0x00, 0x00, 0xF0, 0x81, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0x00, 
  0x00, 0xF8, 0xFF, 0x1F, 0x00, 0x00, 0xF8, 0xFF, 0x1F, 0x00, 0x00, 0xFC, 
  0xFF, 0x3F, 0x00, 0x00, 0xFC, 0xFF, 0x3F, 0x00, 0x00, 0x3E, 0x00, 0x7C, 
  0x00, 0x00, 0x1F, 0x00, 0xF8, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 
  0xF0, 0x00, 0x00, 0x1F, 0x00, 0xF8, 0x00, 0x00, 0x3E, 0x00, 0x7C, 0x00, 
  0x00, 0xFC, 0xFF, 0x3F, 0x00, 0x00, 0xFC, 0xFF, 0x3F, 0x00, 0x00, 0xF8, 
  0xFF, 0x1F, 0x00, 0x00, 0xF8, 0xFF, 0x1F, 0x00, 0x00, 0xF0, 0x00, 0x0F, 
  0x00, 0x00, 0xF0, 0x81, 0x0F, 0x00, 0x00, 0x80, 0x81, 0x01, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, };

void setup() {
  Serial.begin(115200);
  Serial.println("Remote_ESP_init!");
  u8g2.setColorIndex(1);
  u8g2.begin();
  u8g2.setBitmapMode(1);
  but_abort.setDebounceTime(25);
  but_rtb.setDebounceTime(25);
  but_send.setDebounceTime(25);

}

void loop() {
  but_abort.loop();
  but_rtb.loop();
  but_send.loop();
  char key = keypad.getKey(); 
  if (key) {
    if (key == 'A'){
    sprintf(raw_packet, "A%dL%.6fO%.6fS%dF%dE",
            A_val, L_base_val, O_base_val, S_val, F_val);
    Serial.println(raw_packet);
    u8g2.clearBuffer();
    u8g2.setFont(u8g2_font_roentgen_nbp_tf);
    u8g2.setCursor(0, 64); 
    u8g2.print(raw_packet);
    u8g2.drawXBMP( 44, -10, logo_width, logo_height, logo_bits);
    u8g2.sendBuffer();
    }
  }
  delay(10); 

}

